Menu="Utilities"
Type="xmenu"
Title="Storecast"
Icon="sun-o"
Tag="sun-o"
Markdown="false"
---
<?
/* Copyright Derek Macias (parts of code from NUT package)
 * Copyright macester (parts of code from NUT package)
 * Copyright gfjardim (parts of code from NUT package)
 * Copyright SimonF (parts of code from NUT package)
 * Copyright Dan Landon (parts of code from Web GUI)
 * Copyright Bergware International (parts of code from Web GUI)
 * Copyright Lime Technology (any and all other parts of Unraid)
 *
 * Copyright desertwitch (as author and maintainer of this file)
 *
 * This program is free software; you can redistribute it and/or
 * modify it under the terms of the GNU General Public License 2
 * as published by the Free Software Foundation.
 *
 * The above copyright notice and this permission notice shall be
 * included in all copies or substantial portions of the Software.
 *
 */
require_once '/usr/local/emhttp/plugins/dwstorecast/include/dwstorecast_config.php';
if(isset($display['theme']) && $display['theme']) {
    switch ($display['theme']) {
      case 'white': $theme = 'light'; break;
      case 'black': $theme = 'dark'; break;
      case 'azure': $theme = 'light'; break;
      case 'gray' : $theme = 'dark'; break;
      default     : $theme = 'light'; break;
    }
} else { $theme = 'light'; }
?>

<script src="<?autov('/webGui/javascript/jquery.apexcharts.js')?>"></script>

<table class="tablesorter shift">
<thead>
    <tr>
        <th>
            <i class="dwstorecasticon fa fa-cog fa-spin" style="display:none;"></i> <strong>Storage Forecast</strong>
            <span id="dwstorecastmodtimejson" style="float:right;margin-right:10px;"></span>
        </th>
    </tr>
</thead>
<tbody>
    <tr>
        <td>
            <div id="chart"></div>
        </td>
    </tr>
</tbody>
</table>

<div>
    <span class="left" style="font-size:1.1rem;letter-spacing:1px;padding-left:5px;"><strong><i class="icon fa fa-cogs"></i>GENERAL SETTINGS</strong></span>
</div><br>

<form markdown="0" id="dwstorecast-settings" name="dwstorecast_settings" method="POST" action="/update.php" target="progressFrame">
<input type="hidden" name="#file" value="dwstorecast/dwstorecast.cfg">
<input type="hidden" id="dwstorecast-cmd" name="#command" value="/usr/local/emhttp/plugins/dwstorecast/scripts/write_config">

<dl>
    <dt>Show Storage Forecast Dashboard:</dt>
    <dd>
        <select name="DASHBOARD" size="1">
            <?=mk_option($dwstorecast_dashboard, 'disable', 'No');?>
            <?=mk_option($dwstorecast_dashboard, 'enable', 'Yes');?>
        </select>
    </dd>
</dl>

<blockquote class="inline_help">
    <p>Sets if the storage forecast dashboard should be shown on the OS frontpage.</p>
</blockquote>

<dl>
    <dt>Automated Storage Forecast Generation:</dt>
    <dd>
        <select name="FORECASTCRON" size="1">
            <?=mk_option($dwstorecast_forecastcron, 'disable', 'No');?>
            <?=mk_option($dwstorecast_forecastcron, 'hourly', 'Every Hour');?>
            <?=mk_option($dwstorecast_forecastcron, 'daily', 'Every Day');?>
            <?=mk_option($dwstorecast_forecastcron, 'weekly', 'Every Week');?>
            <?=mk_option($dwstorecast_forecastcron, 'monthly', 'Every Month');?>
        </select>
    </dd>
</dl>

<blockquote class="inline_help">
    <p>Sets or disables the schedule to create new storage forecasts in an automated manner.</p>
</blockquote>

<dl>
    <dt>Plugin Usage Metric Functions:</dt>
    <dd>
        <select name="METRICSAPI" size="1">
            <?=mk_option($dwstorecast_metricsapi, 'disable', 'No');?>
            <?=mk_option($dwstorecast_metricsapi, 'enable', 'Yes');?>
        </select>
    </dd>
</dl>

<blockquote class="inline_help">
    <p>Enables collection of <strong>anonymized</strong> plugin usage statistics through the plugin usage metrics API.</p>
    <p>This aids prioritization of bug reports, development of new features and planning for plugin updates/deprecation.</p>
    <p><em>Attributes: Metric ID, Plugin Version and Unraid Version.</em></p>
    <p><strong><i class="fa fa-heart" style="color:red;"></i> If possible, please keep this setting <u>enabled</u> to support the continued development of this plugin - thank you!</strong></p>
</blockquote>

<dl>
        <dt>
            <input type="button" class="dwstorecast-not-run" id="MANUALGENERATE" value="Manual Generation">
            <input type="submit" class="dwstorecast-not-run" name="#default" value="Restore Defaults">
        </dt>
        <dd>
            <input type="submit" name="#apply" value="Apply">
            <input type="button" value="Done" onclick="done()">
        </dd>
    </dl>
</form>

<table class="tablesorter">
<thead>
    <tr>
        <th>
            <i class="dwstorecasticon fa fa-cog fa-spin" style="display:none;"></i> <strong>Storage Forecast - Report</strong>
            <span id="dwstorecastmodtimelog" style="float:right;margin-right:10px;"></span>
        </th>
    </tr>
</thead>
<tbody>
    <tr>
        <td>
            <pre id="dwstorecastlog">
Waiting for Forecast...
            </pre>
        </td>
    </tr>
</tbody>
</table>

<script>
    let chart;
    const availableSpace = <?=json_encode(@disk_total_space('/mnt/user/') ?: 0)?>;

    const options = {
        chart: {
            type: 'line',
            height: 400,
            toolbar: { show: false },
            zoom: { enabled: false },
            animations: { enabled: false },
        },
        series: [],
        colors: ['#007BFF', '#007BFF', '#C63821', '#EA9000'],
        xaxis: {
            type: 'datetime',
            title: { text: 'Time' },
        },
        yaxis: {
            title: { text: 'Storage' },
            labels: {
                formatter: function(value) {
                    return formatBytes(value);
                },
            },
        },
        noData: {
            text: 'Waiting for Forecast...',
            align: 'center',
            verticalAlign: 'middle',
            style: {
                color: '#666',
                fontSize: '16px',
            },
        },
        legend: {
            horizontalAlign: 'right',
        },
        <? if(file_exists("/mnt/user")): ?>
        annotations: {
            yaxis: [{
                y: 0,
                y2: availableSpace,
                fillColor: '#D7F6D5',
                label: {
                    style: { color: '#fff', background: '#387B1D' },
                    text: `Installed Storage (${formatBytes(availableSpace)})`,
                },
            }],
        },
        <? endif; ?>
        stroke: {
            width: [2, 2, 1, 1],
            dashArray: [0, 4, 4, 4],
        },
        markers: {
            size: 4,
        },
        tooltip: {
            x: { format: 'yyyy-MM-dd' },
            y: {
                formatter: function(value) {
                    return formatBytes(value);
                },
            },
        },
        theme: { mode:'<?=$theme?>' },
    };

    function formatBytes(bytes) {
        if (bytes === 0) return '0 B';
        const k = 1000;
        const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }

    function fetchChartData() {
        return $.ajax({
            url: '/plugins/dwstorecast/storecast.json?nocache=' + new Date().getTime(),
            dataType: 'json',
        }).then((data) => {
            if (!data.history || !data.forecast) {
                chart.updateOptions({
                    noData: {
                        text: 'Waiting for Forecast...',
                        align: 'center',
                        verticalAlign: 'middle',
                        style: { color: '#666', fontSize: '16px' },
                    },
                });
                return { timestamp: [], history: [], forecast: [], forecastUp: [], forecastDown: [] };
            }

            if (data.history.length > 0 && data.forecast.length > 0) {
                const lastHistoryPoint = data.history[data.history.length - 1];
                const firstForecastPoint = data.forecast[0];
                if (lastHistoryPoint.x !== firstForecastPoint.x) {
                    data.forecast.unshift({ x: lastHistoryPoint.x, y: lastHistoryPoint.y });
                }
            }

            const forecastWithDeviation = data.forecast.map((dp, index) => {
                const yUp = dp.y * 1.2;
                const yDown = dp.y * 0.8;
                // if (index === 0) {
                //     return {
                //         x: dp.x,
                //         y: dp.y,
                //         yUp: dp.y, // Connect to last history point
                //         yDown: dp.y // Connect to last history point
                //     };
                // }
                return { x: dp.x, y: dp.y, yUp, yDown };
            });

            return {
                timestamp: data.timestamp,
                history: data.history.map((dp) => ({ x: dp.x, y: dp.y })),
                forecast: forecastWithDeviation.map((dp) => ({ x: dp.x, y: dp.y })),
                forecastUp: forecastWithDeviation.map((dp) => ({ x: dp.x, y: dp.yUp })),
                forecastDown: forecastWithDeviation.map((dp) => ({ x: dp.x, y: dp.yDown })),
            };
        }).catch((error) => {
            console.error('Error loading chart data:', error);
            chart.updateOptions({
                noData: {
                    text: 'Failed to load forecast. Please re-generate it.',
                    align: 'center',
                    verticalAlign: 'middle',
                    style: { color: '#FF0000', fontSize: '16px' },
                },
            });
        });
    }

    function updateChart() {
        clearTimeout(timers.updateStorecast);
        fetchChartData()
            .then((chartData) => {
                if (!chartData) return;
                chart.updateSeries([
                    { name: 'History', data: chartData.history },
                    { name: 'Forecast', data: chartData.forecast },
                    { name: 'Forecast +20%', data: chartData.forecastUp },
                    { name: 'Forecast -20%', data: chartData.forecastDown },
                ]);
                if(chartData.timestamp) {
                    $('#dwstorecastmodtimejson').html(`<strong>Chart Generated:</strong> ${chartData.timestamp}`);
                } else {
                    $('#dwstorecastmodtimejson').html("<strong>Chart Generated:</strong> n/a");
                }     
            })
            .catch((error) => {
                console.error('Error fetching chart data:', error);
                chart.updateOptions({
                    noData: {
                        text: 'Failed to load forecast. Please re-generate it.',
                        align: 'center',
                        verticalAlign: 'middle',
                        style: { color: '#FF0000', fontSize: '16px' },
                    },
                });
            })
            .always(() => {
                timers.updateStorecast = setTimeout(updateChart, 10000);
            });
    }

    function updateLogs() {
        clearTimeout(timers.updateStorecastLog);
        $.get('/plugins/dwstorecast/include/dwstorecast_log.php', function(data) {
            if (data && data.response) {
                if (data.running) {
                    $('.dwstorecasticon').show();
                    $('#dwstorecastmodtimelog').hide();
                    $('#dwstorecastmodtimejson').hide();
                    $('#dwstorecastmanual').prop('disabled', true);
                    $('.dwstorecast-run').prop('disabled', false);
                    $('.dwstorecast-not-run').prop('disabled', true);

                } else {
                    if(data.modtime_log) {
                        $('#dwstorecastmodtimelog').html(`<strong>Report Generated:</strong> ${data.modtime_log}`);
                    } else {
                        $('#dwstorecastmodtimelog').html("<strong>Report Generated:</strong> n/a");
                    }
                    $('.dwstorecasticon').hide();
                    $('#dwstorecastmodtimelog').show();
                    $('#dwstorecastmodtimejson').show();
                    $('#dwstorecastmanual').prop('disabled', false);
                    $('.dwstorecast-run').prop('disabled', true);
                    $('.dwstorecast-not-run').prop('disabled', false);
                }
                $('#dwstorecastlog').html(data.response);
            }
        }, 'json').always(function() {
            timers.updateStorecastLog = setTimeout(updateLogs, 10000);
        });
    }

    $(function() {
        chart = new ApexCharts($('#chart')[0], options);
        chart.render();
        updateChart();
        updateLogs();

        $('#MANUALGENERATE').click(function(){
            $('#dwstorecast-cmd').val('/usr/local/emhttp/plugins/dwstorecast/scripts/generate');
            $('#dwstorecast-settings').submit();
        });
    });
</script>
